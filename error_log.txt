============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\elmo_\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\elmo_\Documents\Proyectos\Resonance-audio-builder
configfile: pyproject.toml
testpaths: tests
plugins: anyio-3.7.1, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 114 items / 1 error

<Dir Resonance-audio-builder>
  <Package tests>
    <Module test_audio_analysis.py>
      <Class TestAudioAnalyzer>
        Tests for Fake HQ detection and audio analysis
        <Function test_analyze_genuine_320kbps>
          Genuine 320kbps file should pass
        <Function test_analyze_fake_upscaled_128k>
          128k upscaled to 320k should fail
        <Function test_analyze_missing_file>
          Missing file should return False
        <Function test_analyze_corrupted_file>
          Corrupted file should return True (fail open) as per implementation
        <Function test_analyze_with_custom_cutoff>
          Custom cutoff should be passed to ffmpeg
        <Function test_analyze_flac_lossless>
          FLAC files should pass
        <Function test_analyze_silence_file>
          Silence file (low RMS) should be flagged
        <Function test_rms_threshold_boundaries[-90.0-False]>
        <Function test_rms_threshold_boundaries[-60.0-True]>
    <Module test_audio_downloader.py>
      <Class TestAudioDownloader>
        <Coroutine test_download_success_hq_only>
          Test basic successful download flow (HQ only)
        <Coroutine test_download_skip_existing>
          Should skip if file exists and validates
        <Coroutine test_transcode_calls_ffmpeg>
          Transcode should invoke ffmpeg subprocess
    <Module test_builder.py>
      <Class TestApp>
        <Function test_check_dependencies_success>
        <Function test_check_dependencies_fail>
        <Function test_select_csv_no_files>
        <Function test_select_csv_with_files>
        <Function test_read_csv_success>
        <Function test_read_csv_empty>
        <Function test_deduplicate_tracks>
        <Function test_select_quality>
        <Function test_perform_clear>
        <Function test_retry_failed_no_file>
        <Function test_start_download_empty_list>
        <Function test_read_csv_encodings>
    <Module test_downloader.py>
      <Class TestAudioDownloader>
        <Coroutine test_validate_audio_file_success>
        <Coroutine test_validate_audio_file_invalid>
        <Coroutine test_download_skip_if_exists>
        <Coroutine test_transcode_mp3>
        <Function test_get_ytdlp_options>
        <Function test_handle_ytdlp_error_retryable>
        <Function test_handle_ytdlp_error_fatal>
        <Function test_build_ffmpeg_cmd>
        <Coroutine test_check_fake_hq>
        <Coroutine test_fetch_metadata_assets>
        <Function test_handle_ytdlp_error_geo>
    <Module test_functional_scenarios.py>
      <Class TestRealWorldScenarios>
        Scenarios based on real usage patterns
        <Function test_playlist_csv_parsing>
          Parsing a large CSV playlist
        <Function test_very_long_track_name>
          Track with 300 chars should specific filename logic
        <Function test_special_characters_handling>
          Emoji and unicode should be preserved or sanitized
    <Module test_input.py>
      <Class TestKeyboardController>
        <Function test_initial_state>
        <Function test_handle_pause>
        <Function test_handle_skip>
        <Function test_handle_quit>
        <Function test_start_stop>
    <Module test_integration_pipeline.py>
      <Class TestDownloadPipeline>
        Tests end-to-end of the pipeline mock
        <Coroutine test_full_pipeline_single_track>
          Happy path: Search -> Download -> Mark Done
        <Coroutine test_pipeline_retry_logic>
          Should retry on RecoverableError
    <Module test_library_builder.py>
      <Class TestConfig>
        Tests for Config class
        <Function test_default_values>
          Config should have sensible defaults
        <Function test_load_from_json>
          Config.load() should read from JSON file
        <Function test_load_missing_file>
          Config.load() should return defaults if file missing
      <Class TestTrackMetadata>
        Tests for TrackMetadata class
        <Function test_from_csv_row_basic>
          Should parse basic CSV row
        <Function test_from_csv_row_no_isrc>
          Should generate hash ID when no ISRC
        <Function test_safe_filename>
          Should remove invalid characters from filename
        <Function test_format_size>
        <Function test_format_time>
        <Function test_is_valid_quality>
        <Function test_bool_comparisons>
        <Function test_safe_filename_reserved>
          Should produce valid filename even with reserved names
        <Function test_duration_seconds>
          Should convert milliseconds to seconds
      <Class TestUtilityFunctions>
        Tests for utility functions
        <Function test_format_time_seconds>
        <Function test_format_size>
        <Function test_calculate_md5>
          Should calculate correct MD5 hash
        <Function test_calculate_md5_missing_file>
          Should return empty string for missing file
      <Class TestRateLimiter>
        Tests for RateLimiter class
        <Function test_initial_delay>
        <Function test_error_increases_delay>
        <Function test_success_decreases_delay>
        <Function test_max_delay_limit>
      <Class TestValidateCookies>
        Tests for cookies validation
        <Function test_valid_cookies>
        <Function test_invalid_cookies>
        <Function test_missing_file>
      <Class TestExportM3U>
        Tests for M3U export
        <Function test_export_m3u>
      <Class TestSaveHistory>
        Tests for session history
        <Function test_save_history>
        <Function test_history_limit>
          Should keep only last 50 sessions
      <Class TestCacheManager>
        Tests for SQLite CacheManager
        <Function test_init>
        <Function test_set_get>
        <Function test_expiry>
    <Module test_logger.py>
      <Class TestLogger>
        <Function test_logger_info>
        <Function test_logger_debug_disabled>
        <Function test_logger_error>
    <Module test_lyrics.py>
      <Class TestLyrics>
        <Function test_fetch_lyrics_success>
        <Function test_fetch_lyrics_not_found>
    <Module test_manager.py>
      <Class TestDownloadManagerUnit>
        <Coroutine test_process_track_attempts_success>
        <Coroutine test_worker_loop>
        <Coroutine test_process_track_fatal_error>
        <Coroutine test_process_track_recoverable_retry>
    <Module test_network_limiter_expanded.py>
      <Class TestRateLimiterExpanded>
        <Coroutine test_wait_logic>
        <Function test_adjust_delay>
    <Module test_proxy_manager.py>
      <Class TestProxyManager>
        <Function test_load_proxies>
          Should load proxies from file
        <Function test_get_proxy_random_selection>
          Should return a proxy
        <Coroutine test_health_check_valid_proxy>
          Valid proxy should remain in list
        <Function test_ban_after_threshold>
          Should ban proxy after failures
        <Function test_disabled_returns_none>
          Null file should act as disabled
    <Module test_rate_limiter.py>
      <Class TestRateLimiter>
        <Function test_initial_delay>
          Initial delay should be min_delay
        <Function test_success_reduces_delay>
          Success reduces delay
        <Function test_error_increases_delay>
          Error increases delay exponentially
        <Function test_max_delay_cap>
          Delay should not exceed max
        <Function test_concurrent_usage>
          Thread safety check
    <Module test_security_platform.py>
      <Class TestSecurityConcerns>
        <Function test_filename_path_traversal_attack>
          Checking for path traversal attempts
        <Function test_command_injection_in_filename>
          Checking for shell characters
      <Class TestCrossPlatform>
        <Function test_windows_reserved_filenames>
          CON, AUX should be mapped
        <Function test_path_compatibility>
          Paths should use correct separators
    <Module test_state.py>
      <Class TestProgressDB>
        <Function test_mark_and_get_stats>
        <Function test_is_done>
        <Function test_persistence>
    <Module test_tagging.py>
      <Class TestMetadataWriter>
        <Function test_write_metadata>
        <Function test_add_text_tags>
        <Function test_add_cover>
    <Module test_ui.py>
      <Class TestRichUI>
        <Function test_start_stop>
        <Function test_add_download_task>
        <Function test_update_task_status>
        <Function test_update_main_progress>
    <Module test_youtube_searcher.py>
      <Class TestYouTubeSearcher>
        <Coroutine test_search_by_text_success>
          Standard search should return result
        <Coroutine test_search_not_found>
          Empty results should raise NotFoundError
        <Coroutine test_search_excludes_covers>
          Should filter out covers by default
        <Coroutine test_search_cache_hit>
          Second search should hit cache (mocking cache manager)
        <Coroutine test_search_network_error>
          Network error should be handled

=================================== ERRORS ====================================
____________ ERROR collecting tests/test_network_utils_expanded.py ____________
ImportError while importing test module 'C:\Users\elmo_\Documents\Proyectos\Resonance-audio-builder\tests\test_network_utils_expanded.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
..\..\..\AppData\Local\Programs\Python\Python313\Lib\importlib\__init__.py:88: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests\test_network_utils_expanded.py:2: in <module>
    from resonance_audio_builder.network.utils import get_random_user_agent, is_valid_ip
E   ImportError: cannot import name 'get_random_user_agent' from 'resonance_audio_builder.network.utils' (C:\Users\elmo_\Documents\Proyectos\Resonance-audio-builder\src\resonance_audio_builder\network\utils.py)
=========================== short test summary info ===========================
ERROR tests/test_network_utils_expanded.py
!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!
==================== 114 tests collected, 1 error in 1.41s ====================
